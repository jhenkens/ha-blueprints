blueprint:
  name: Auto Lock
  description: Automatically locks a door after it is unlocked
  domain: automation
  author: Johan Henkens (https://github.com/jhenkens)
  source_url: https://raw.githubusercontent.com/jhenkens/ha-blueprints/main/automations/auto_lock.yaml
  input:
    lock:
      name: Lock
      description: Lock
      selector:
        entity:
          domain:
            - lock
          multiple: false
    auto_lock_timer:
      name: Auto Lock Timer
      description: Auto Lock Timer
      default: timer.none
      selector:
        entity:
          domain:
            - timer
          multiple: false
    daily_check_enabled:
      name: Enable Daily Auto-Lock Check
      description: Once a day, lock the door if it is unlocked (failsafe in case the timer breaks).
      default: false
      selector:
        boolean:
    daily_check_time:
      name: Daily Auto-Lock Check Time
      description: Time of day to run the daily auto-lock check. Only used if the daily check is enabled.
      default: "02:00:00"
      selector:
        time:
    notify_devices:
      name: Notification Devices
      description: >-
        Devices to notify if the lock fails to lock after 60 seconds.
        Leave empty to disable notifications.
      default: []
      selector:
        device:
          integration: mobile_app
          multiple: true
    use_home_name:
      name: Title Notifications Using Home's Friendly Name
      description: >-
        If enabled, notification titles will be prefixed with the friendly name
        of zone.home (e.g. "My Home - Failed to Lock").
      default: false
      selector:
        boolean:

variables:
  lock: !input lock
  auto_lock_timer: !input auto_lock_timer
  daily_check_enabled: !input daily_check_enabled
  daily_check_time: !input daily_check_time
  notify_devices: !input notify_devices
  use_home_name: !input use_home_name
  home_name: >-
    {{ state_attr('zone.home', 'friendly_name') if use_home_name else '' }}

trigger:
  - platform: state
    entity_id: !input lock
    from: locked
    to: unlocked
    id: Lock Unlocked
  - platform: state
    entity_id: !input lock
    from: unlocked
    to: locked
    id: Lock Locked
  - platform: state
    entity_id: !input auto_lock_timer
    from: active
    to: idle
    id: Timer Finished
  - platform: time
    at: !input daily_check_time
    id: Daily Check

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger is none or trigger.id is not defined }}"
        sequence:
          - repeat:
              for_each: "{{ notify_devices }}"
              sequence:
                - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                  data:
                    title: "{{ home_name }}"
                    message: >-
                      Lock: {{ state_attr(lock, 'friendly_name') | default(lock) }} ({{ lock }})
                      Timer: {{ auto_lock_timer }}
                      Daily Check: {{ daily_check_enabled }}
                      Daily Check Time: {{ daily_check_time }}
                      Notify Devices: {{ notify_devices | map('device_attr', 'name') | list | join(', ') }}
                      Lock State: {{ states(lock) }}
      - conditions:
          - condition: trigger
            id:
              - Lock Locked
        sequence:
          - if:
              - condition: template
                value_template: "{{ auto_lock_timer != 'timer.none' }}"
            then:
              - if:
                  - condition: state
                    entity_id: !input auto_lock_timer
                    state: active
                then:
                  - service: timer.cancel
                    metadata: {}
                    data: {}
                    target:
                      entity_id: !input auto_lock_timer
      - conditions:
          - condition: trigger
            id:
              - Lock Unlocked
        sequence:
          - if:
              - condition: template
                value_template: "{{ auto_lock_timer != 'timer.none' }}"
            then:
              - if:
                  - condition: state
                    entity_id: !input auto_lock_timer
                    state: active
                then:
                  - service: timer.cancel
                    metadata: {}
                    data: {}
                    target:
                      entity_id: !input auto_lock_timer
                  - service: timer.start
                    metadata: {}
                    data: {}
                    target:
                      entity_id: !input auto_lock_timer
                else:
                  - service: timer.start
                    metadata: {}
                    data: {}
                    target:
                      entity_id: !input auto_lock_timer
      - conditions:
          - condition: or
            conditions:
              - condition: and
                conditions:
                  - condition: trigger
                    id:
                      - Timer Finished
                  - condition: template
                    value_template: "{{ auto_lock_timer != 'timer.none' }}"
              - condition: and
                conditions:
                  - condition: trigger
                    id:
                      - Daily Check
                  - condition: template
                    value_template: "{{ daily_check_enabled }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ states(lock) in ['unknown', 'unavailable'] }}"
            then:
              - repeat:
                  for_each: "{{ notify_devices }}"
                  sequence:
                    - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                      data:
                        title: "{{ home_name }}"
                        message: >-
                          {{ state_attr(lock, 'friendly_name') | default(lock) }}
                          is {{ states(lock) }} and cannot be locked.
              - stop: "Lock is in an error state"
          - if:
              - condition: template
                value_template: "{{ states(lock) != 'locked' }}"
            then:
              - service: lock.lock
                metadata: {}
                data: {}
                target:
                  entity_id: !input lock
              - wait_template: "{{ is_state(lock, 'locked') }}"
                timeout: "00:01:00"
                continue_on_timeout: true
              - if:
                  - condition: template
                    value_template: "{{ not wait.completed }}"
                then:
                  - repeat:
                      for_each: "{{ notify_devices }}"
                      sequence:
                        - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                          data:
                            title: "{{ home_name }}"
                            message: >-
                              {{ state_attr(lock, 'friendly_name') | default(lock) }}
                              failed to lock after 60 seconds.

mode: queued
max: 5
